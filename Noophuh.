-- Services
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 200, 0, 100)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(50,50,50)
frame.BackgroundTransparency = 0.3
frame.BorderSizePixel = 0

local toggleButton = Instance.new("TextButton", frame)
toggleButton.Size = UDim2.new(1, -20, 0, 50)
toggleButton.Position = UDim2.new(0, 10, 0, 25)
toggleButton.Text = "Fix Lag: OFF"
toggleButton.TextScaled = true
toggleButton.BackgroundColor3 = Color3.fromRGB(100,100,100)
toggleButton.TextColor3 = Color3.fromRGB(255,255,255)

local lagFixEnabled = false

-- Hàm tối ưu hóa
local function fixLag()
    -- Xử lý Terrain
    local Terrain = Workspace:FindFirstChildOfClass('Terrain')
    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 0
    end

    -- Lighting
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 9e9
    settings().Rendering.QualityLevel = 1

    -- Đối tượng hiện tại
    for _,v in pairs(Workspace:GetDescendants()) do
        if v:IsA("Part") or v:IsA("UnionOperation") or v:IsA("MeshPart") then
            v.Material = "Plastic"
            v.Reflectance = 0
        elseif v:IsA("Decal") then
            v.Transparency = 1
        elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
            v.Lifetime = NumberRange.new(0)
        elseif v:IsA("Fire") or v:IsA("Smoke") then
            -- Xóa 50% hiệu ứng
            if math.random() < 0.5 then
                v.Enabled = false
            end
        end
    end

    -- Lighting effects 50%
    for _,v in pairs(Lighting:GetDescendants()) do
        if v:IsA("BlurEffect") or v:IsA("SunRaysEffect") or v:IsA("BloomEffect") then
            if math.random() < 0.5 then
                v.Enabled = false
            end
        end
    end
end

-- Xử lý đối tượng mới
local function onDescendantAdded(child)
    if child:IsA('ForceField') then
        RunService.Heartbeat:Wait()
        child:Destroy()
    elseif child:IsA('Sparkles') or child:IsA('Smoke') or child:IsA('Fire') then
        if math.random() < 0.5 then
            child.Enabled = false
        end
    elseif child:IsA("Part") or child:IsA("UnionOperation") or child:IsA("MeshPart") then
        child.Material = "Plastic"
        child.Reflectance = 0
    elseif child:IsA("Decal") then
        child.Transparency = 1
    elseif child:IsA("ParticleEmitter") or child:IsA("Trail") then
        child.Lifetime = NumberRange.new(0)
    end
end

Workspace.DescendantAdded:Connect(onDescendantAdded)

-- Toggle nút GUI
toggleButton.MouseButton1Click:Connect(function()
    lagFixEnabled = not lagFixEnabled
    if lagFixEnabled then
        toggleButton.Text = "Fix Lag: ON"
        fixLag()
    else
        toggleButton.Text = "Fix Lag: OFF"
        -- Không reset lại, giữ trạng thái hiện tại
    end
end)
